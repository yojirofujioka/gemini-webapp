import streamlit as st
import vertexai
from vertexai.generative_models import GenerativeModel, Part
import json
from google.oauth2 import service_account
import base64

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0. model ã¨èªè¨¼ãƒ•ãƒ©ã‚°ã‚’äº‹å‰å®šç¾©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model = None
GCP_AUTH_SUCCESS = False

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. GCP èªè¨¼ï¼†Vertex AI åˆæœŸåŒ–
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    # .streamlit/secrets.toml ã® [gcp] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚€
    gcp_cfg = st.secrets["gcp"]
    GCP_PROJECT_ID = gcp_cfg["project_id"]
    GCP_REGION     = "asia-northeast1"

    # JSONæ–‡å­—åˆ—ã‚’è¾æ›¸åŒ–
    service_account_info = json.loads(gcp_cfg["gcp_service_account"])
    credentials = service_account.Credentials.from_service_account_info(
        service_account_info
    )

    # Vertex AI åˆæœŸåŒ–
    vertexai.init(
        project     = GCP_PROJECT_ID,
        location    = GCP_REGION,
        credentials = credentials
    )

    # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
    model = GenerativeModel("gemini-1.5-pro")
    GCP_AUTH_SUCCESS = True

except Exception as e:
    st.error(
        f"âŒ GCP èªè¨¼ï¼Vertex AI ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n"
        f"Secrets ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: {e}"
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. UI éƒ¨åˆ†
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.title("ğŸ“· AIã«ã‚ˆã‚‹ãƒªãƒ•ã‚©ãƒ¼ãƒ ç®‡æ‰€åˆ†æã‚¢ãƒ—ãƒª")
st.markdown("""
360åº¦å†™çœŸã‚„ã€æ°—ã«ãªã‚‹ç®‡æ‰€ã®è©³ç´°ãªå†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚  
AIãŒå†™çœŸã‚’åˆ†æã—ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ã‚„ä¿®ç¹•ãŒå¿…è¦ãªç®‡æ‰€ã‚’è‡ªå‹•ã§ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
""")

# ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
uploaded = st.file_uploader(
    "åˆ†æã—ãŸã„å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
    type=["png", "jpg", "jpeg"],
    accept_multiple_files=True
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç›´å¾Œã«ã‚µãƒ ãƒã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if uploaded:
    st.subheader("ğŸ”½ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ï¼‰")
    cols = st.columns(3)
    for idx, file in enumerate(uploaded):
        b64 = base64.b64encode(file.getvalue()).decode()
        mime = file.type
        thumb_html = (
            f'<a href="data:{mime};base64,{b64}" target="_blank">'
            f'<img src="data:{mime};base64,{b64}" width="150" '
            f'style="border:1px solid #ddd; border-radius:4px;" />'
            '</a>'
        )
        cols[idx % 3].markdown(f"**{file.name}**  \n{thumb_html}",
                               unsafe_allow_html=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
prompt = """
ã‚ãªãŸã¯ã€æ—¥æœ¬ã®ãƒªãƒ•ã‚©ãƒ¼ãƒ ãƒ»åŸçŠ¶å›å¾©å·¥äº‹ã‚’å°‚é–€ã¨ã™ã‚‹ã€çµŒé¨“è±Šå¯Œãªç©ç®—æ‹…å½“è€…ã§ã™ã€‚

ã“ã‚Œã‹ã‚‰æä¾›ã™ã‚‹ç¾å ´å†™çœŸã¨å›³é¢ã«åŸºã¥ãã€ä»¥ä¸‹ã®#å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨#å ±å‘Šæ›¸ä½œæˆãƒ«ãƒ¼ãƒ«ã«å³å¯†ã«å¾“ã£ã¦ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå ±å‘Šæ›¸ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã¯ã€ç†æƒ³çš„ãªå ±å‘Šæ›¸ã®ã™ã¹ã¦ã®è¦ç´ ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ 

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

ç‰©ä»¶å: (ä¾‹: â—‹â—‹ãƒ“ãƒ« 301å·å®¤)
ä½æ‰€: (ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒºâ—‹â—‹ 1-2-3)
ä¾é ¼ä¸»ã®è¦æœ›:
(ä¾‹: 2LDKã‚’åºƒã„1LDKã«å¤‰æ›´ã—ãŸã„)
(ä¾‹: å†…è£…ã¯ç™½ã‚’åŸºèª¿ã¨ã—ãŸã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ€ãƒ³ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¸Œæœ›)
(ä¾‹: æ°´å›ã‚Šã®è¨­å‚™ã¯ã™ã¹ã¦ä¸€æ–°ã—ãŸã„)
(ä¾‹: äºˆç®—ã¯ç¨è¾¼ã¿ã§XXXä¸‡å††ä»¥å†…ã‚’å¸Œæœ›)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
ç¾å ´å†™çœŸ:
[å†™çœŸ1.jpg] - [å†™çœŸ5.jpg]: å„éƒ¨å±‹ã®ç¾çŠ¶ï¼ˆãƒªãƒ“ãƒ³ã‚°ã€å’Œå®¤ã€ã‚­ãƒƒãƒãƒ³ã€æµ´å®¤ã€ãƒˆã‚¤ãƒ¬ï¼‰
[å†™çœŸ6.jpg]: ã‚­ãƒƒãƒãƒ³ã®é…ç®¡å‘¨ã‚Šã®è…é£ŸãŒç¢ºèªã§ãã‚‹ã‚¢ãƒƒãƒ—
[å†™çœŸ7.jpg]: çª“ã‚µãƒƒã‚·ã®æ­ªã¿ã¨éš™é–“ãŒã‚ã‹ã‚‹ã‚¢ãƒƒãƒ—

å›³é¢:
[å¹³é¢å›³.pdf]: å„éƒ¨å±‹ã®å¯¸æ³•ã€é–“å–ã‚Šã€å»ºå…·ã®ä½ç½®ãŒè¨˜è¼‰
[é›»æ°—é…ç·šå›³.pdf]: æ—¢å­˜ã®ã‚¹ã‚¤ãƒƒãƒã€ã‚³ãƒ³ã‚»ãƒ³ãƒˆã€ç…§æ˜ã®ä½ç½®ãŒè¨˜è¼‰

# å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
ä»¥ä¸‹ã®æ§‹æˆã¨é …ç›®ã‚’å³å¯†ã«å®ˆã‚Šã€å ±å‘Šæ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ 

1. ãƒ˜ãƒƒãƒ€ãƒ¼

æ›¸é¡å: ç¾å ´èª¿æŸ»å ±å‘Šæ›¸ 
å ±å‘Šæ›¸ç•ªå·: No. (8æ¡ã®æ•°å­—ã§è‡ªå‹•ç”Ÿæˆ) 
ç™ºè¡Œæ—¥: (ä»Šæ—¥ã®æ—¥ä»˜)

ç™ºè¡Œå…ƒæƒ…å ±:
ä¼šç¤¾å: (ã‚ãªãŸã®ä¼šç¤¾å)
ä½æ‰€: (ã‚ãªãŸã®ä½æ‰€)
é›»è©±/FAX: (ã‚ãªãŸã®é€£çµ¡å…ˆ)
ç™»éŒ²ç•ªå·: (ä¾‹: T3010901009251) 111111111

2. ç‰©ä»¶æƒ…å ±

ç‰©ä»¶å: (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã‹ã‚‰è»¢è¨˜)
ä½æ‰€: (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã‹ã‚‰è»¢è¨˜)

3. å†™çœŸã®ã‚µãƒ ãƒã‚¤ãƒ«ã€å†™çœŸã«ã¤ã„ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆ
"""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. åˆ†æé–‹å§‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.button("åˆ†æã‚’é–‹å§‹ã™ã‚‹"):
    # èªè¨¼ãƒã‚§ãƒƒã‚¯
    if not GCP_AUTH_SUCCESS:
        st.error("âŒ GCP èªè¨¼ãŒå®Œäº†ã—ã¦ã„ãªã„ãŸã‚ã€å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™ã€‚")
        st.stop()

    if not uploaded:
        st.warning("âš ï¸ ã¾ãšã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
        st.stop()

    if model is None:
        st.error("âŒ ãƒ¢ãƒ‡ãƒ«ãŒãƒ­ãƒ¼ãƒ‰ã§ãã¦ã„ã¾ã›ã‚“ã€‚ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚")
        st.stop()

    with st.spinner("AIãŒå†™çœŸã‚’åˆ†æä¸­ã§ã™â€¦"):
        # ç”»åƒã‚’ Part ã«å¤‰æ›
        parts = [
            Part.from_data(data=f.getvalue(), mime_type=f.type)
            for f in uploaded
        ]
        contents = [prompt] + parts

        try:
            response = model.generate_content(contents)
        except Exception as e:
            st.error(f"ãƒ¢ãƒ‡ãƒ«å‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            st.stop()

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # åˆ†æçµæœã®æç”»
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.subheader("ğŸ” åˆ†æçµæœ")
    lines = response.text.splitlines()

    # 1ã€œ2ç¯€ã‚’ãã®ã¾ã¾å‡ºåŠ›
    for line in lines:
        if line.startswith("3. å†™çœŸã®ã‚µãƒ ãƒã‚¤ãƒ«"):
            break
        st.markdown(line)

    # ãƒ†ãƒ¼ãƒ–ãƒ«éƒ¨åˆ†ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ (å†™çœŸãƒ©ãƒ™ãƒ«, ã‚³ãƒ¡ãƒ³ãƒˆ) ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
    table_rows = []
    in_table = False
    for line in lines:
        if line.strip().startswith("| å†™çœŸ") and "ã‚³ãƒ¡ãƒ³ãƒˆ" in line:
            in_table = True
            continue
        if in_table:
            if line.strip().startswith("| å†™çœŸ"):
                cols = [c.strip() for c in line.split("|")[1:-1]]
                # [ãƒ©ãƒ™ãƒ«, ã‚µãƒ ãƒã‚¤ãƒ«, ã‚³ãƒ¡ãƒ³ãƒˆ]
                if len(cols) >= 3:
                    table_rows.append((cols[0], cols[2]))
            else:
                break  # ãƒ†ãƒ¼ãƒ–ãƒ«çµ‚äº†

    # å„å†™çœŸã”ã¨ã«ã‚µãƒ ãƒã‚¤ãƒ«ï¼‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
    st.markdown("### ğŸ“¸ å„å†™çœŸã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ã‚³ãƒ¡ãƒ³ãƒˆ")
    for idx, file in enumerate(uploaded):
        label, comment = (
            table_rows[idx]
            if idx < len(table_rows)
            else (f"å†™çœŸ{idx+1}", "")
        )
        b64 = base64.b64encode(file.getvalue()).decode()
        mime = file.type
        thumb_html = (
            f'<a href="data:{mime};base64,{b64}" target="_blank">'
            f'<img src="data:{mime};base64,{b64}" width="150" '
            f'style="border:1px solid #ddd; border-radius:4px;" />'
            '</a>'
        )

        st.markdown(
            f"**{label}ï¼š{file.name}**  \n"
            f"{thumb_html}  \n\n"
            f"**ã‚³ãƒ¡ãƒ³ãƒˆ:** {comment}",
            unsafe_allow_html=True
        )

    st.success("âœ… åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼")
